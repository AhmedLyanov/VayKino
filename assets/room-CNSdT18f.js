import{_ as f,c as n,a as e,t as l,b as u,d as h,F as m,r as g,w as k,v as _,e as v,l as w,f as y,o as c}from"./index-DiMC-kp1.js";const I={data(){return{room:{name:"",users:[],leader:{_id:null},maxUsers:10},messages:[],newMessage:"",socket:null,isLeader:!1,defaultAvatar:y,user:null}},async created(){try{const t=localStorage.getItem("user");if(!t)throw new Error("Пользователь не авторизован");this.user=JSON.parse(t),await this.fetchRoomData(),await this.setupSocketConnection()}catch(t){console.error("Ошибка инициализации:",t),this.$toast.error("Не удалось загрузить комнату",{position:"top-right",duration:2e3}),this.$router.push("/kinoroom")}},beforeUnmount(){this.socket&&this.socket.disconnect()},methods:{formatTime(t){return new Date(t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},async fetchRoomData(){const t=this.$route.params.id;try{const s=localStorage.getItem("token"),o=await fetch(`https://dreamfood.space:3000/rooms/${t}`,{headers:{Authorization:s}});if(!o.ok)throw new Error("Ошибка загрузки данных комнаты");this.room=await o.json(),this.isLeader=this.room.leader._id===this.user._id;const d=await fetch(`https://dreamfood.space:3000/chat-messages?roomId=${t}`,{headers:{Authorization:s}});d.ok&&(this.messages=await d.json())}catch(s){throw console.error("Ошибка:",s),s}},async setupSocketConnection(){try{const t=this.$route.params.id,s=localStorage.getItem("token");if(!this.user||!this.user._id)throw new Error("Данные пользователя не загружены");this.socket=w("https://dreamfood.space:3000",{query:{roomId:t,userId:this.user._id},extraHeaders:{Authorization:s}}),this.socket.on("connect",()=>{console.log("Connected to socket")}),this.socket.on("usersInRoom",o=>{this.room.users=o}),this.socket.on("newMessage",o=>{this.messages.push(o),this.scrollChatToBottom()}),this.socket.on("userJoined",o=>{this.$toast.info(`${o.login} вошел в комнату`,{position:"top-right",duration:2e3})}),this.socket.on("userLeft",o=>{const d=this.room.users.find(a=>a.userId===o);d&&this.$toast.info(`${d.login} вышел из комнаты`,{position:"top-right",duration:2e3})}),this.socket.on("error",o=>{this.$toast.error(o,{position:"top-right",duration:2e3})})}catch(t){throw console.error("Ошибка подключения к сокету:",t),t}},async leaveRoom(){try{const t=localStorage.getItem("token");if(!(await fetch(`https://dreamfood.space:3000/rooms/${this.$route.params.id}/leave`,{method:"POST",headers:{Authorization:t}})).ok)throw new Error("Ошибка при выходе из комнаты");const o=JSON.parse(localStorage.getItem("user"));o.currentRoom=null,localStorage.setItem("user",JSON.stringify(o)),this.$router.push("/kinoroom")}catch(t){console.error("Ошибка:",t),this.$toast.error("Не удалось покинуть комнату",{position:"top-right",duration:2e3})}},async deleteRoom(){if(this.isLeader)try{const t=localStorage.getItem("token");if(!(await fetch(`https://dreamfood.space:3000/rooms/${this.$route.params.id}`,{method:"DELETE",headers:{Authorization:t}})).ok)throw new Error("Ошибка при удалении комнаты");const o=JSON.parse(localStorage.getItem("user"));o.currentRoom=null,localStorage.setItem("user",JSON.stringify(o)),this.$router.push("/kinoroom")}catch(t){console.error("Ошибка:",t),this.$toast.error("Не удалось удалить комнату",{position:"top-right",duration:2e3})}},sendMessage(){if(!this.newMessage.trim())return;const t={sender:this.user.login,text:this.newMessage,avatarUrl:this.user.avatarUrl,roomId:this.$route.params.id};this.socket&&this.socket.emit("sendMessage",t),this.newMessage=""},scrollChatToBottom(){this.$nextTick(()=>{const t=this.$refs.messagesContainer;t&&(t.scrollTop=t.scrollHeight)})}}},S={class:"room-page"},M={class:"room-header"},x={class:"room-title"},R={class:"room-controls"},C={class:"room-content"},T={class:"sidebar"},b={class:"users-section"},E={class:"section-title"},A={class:"users-count"},L={class:"users-list"},N=["src"],U={class:"user-info"},D={class:"user-name"},J={key:0,class:"leader-badge"},O={class:"chat-section"},$={class:"messages",ref:"messagesContainer"},z=["src"],B={class:"message-content"},V={class:"message-header"},j={class:"message-sender"},F={class:"message-time"},H={class:"message-text"},K={class:"message-input"};function q(t,s,o,d,a,i){return c(),n("div",S,[e("div",M,[e("div",x,[e("h1",null,l(a.room.name),1)]),e("div",R,[e("button",{class:"leave-btn",onClick:s[0]||(s[0]=(...r)=>i.leaveRoom&&i.leaveRoom(...r))},s[5]||(s[5]=[e("i",{class:"fas fa-sign-out-alt"},null,-1),h(" Покинуть комнату ")])),a.isLeader?(c(),n("button",{key:0,class:"delete-btn",onClick:s[1]||(s[1]=(...r)=>i.deleteRoom&&i.deleteRoom(...r))},s[6]||(s[6]=[e("i",{class:"fas fa-trash-alt"},null,-1),h(" Удалить комнату ")]))):u("",!0)])]),e("div",C,[e("div",T,[e("div",b,[e("h2",E,[s[7]||(s[7]=e("i",{class:"fas fa-users"},null,-1)),s[8]||(s[8]=h(" Участники ")),e("span",A,"("+l(a.room.users.length)+"/"+l(a.room.maxUsers)+")",1)]),e("div",L,[(c(!0),n(m,null,g(a.room.users,r=>(c(),n("div",{key:r.userId,class:"user-card"},[e("img",{src:r.avatarUrl||a.defaultAvatar,class:"user-avatar"},null,8,N),e("div",U,[e("span",D,l(r.login),1),r.userId===a.room.leader._id?(c(),n("span",J,s[9]||(s[9]=[e("i",{class:"fas fa-crown"},null,-1),h(" Создатель ")]))):u("",!0)])]))),128))])]),e("div",O,[s[11]||(s[11]=e("h2",{class:"section-title"},[e("i",{class:"fas fa-comments"}),h(" Чат комнаты ")],-1)),e("div",$,[(c(!0),n(m,null,g(a.messages,(r,p)=>(c(),n("div",{key:p,class:"message"},[e("img",{src:r.avatarUrl||a.defaultAvatar,class:"message-avatar"},null,8,z),e("div",B,[e("div",V,[e("span",j,l(r.sender),1),e("span",F,l(i.formatTime(r.timestamp)),1)]),e("p",H,l(r.text),1)])]))),128))],512),e("div",K,[k(e("input",{"onUpdate:modelValue":s[2]||(s[2]=r=>a.newMessage=r),onKeyup:s[3]||(s[3]=v((...r)=>i.sendMessage&&i.sendMessage(...r),["enter"])),placeholder:"Напишите сообщение...",class:"chat-input"},null,544),[[_,a.newMessage]]),e("button",{onClick:s[4]||(s[4]=(...r)=>i.sendMessage&&i.sendMessage(...r)),class:"send-btn"},s[10]||(s[10]=[e("i",{class:"fas fa-paper-plane"},null,-1)]))])])])])])}const G=f(I,[["render",q],["__scopeId","data-v-fe2cf0e2"]]);export{G as default};
